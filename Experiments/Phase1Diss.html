<!doctype html>
<html>
  <head>
    <title>Hyperboloid</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="jspsych-5.0.3/jspsych.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-text.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-survey-multi-choice.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-instructions.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-single-stim.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-html.js"></script>
    <link href="jspsych-5.0.3/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  </head>
  <body>
    <div id="jspsych-target"></div>
  </body>
  <script>
    //Experiment 1
  // defining groups of questions that will go together.
  var page_1_questions = ["Which deal would you take?"];
  var trialcountA = 0;
  var Prospects = [800, 40000];
  var Delays = ["immediately", "in 1 month", "in 6 months", "in 2 years", "in 5 years"];
  var Odds = ["10%", "25%", "40%", "80%", "100%"];
  var shuffledProspects = jsPsych.randomization.shuffle(Prospects);
  var randProsp = shuffledProspects[0];
  var ProspectA = shuffledProspects[0]/2;
  var AdjustmentA = ProspectA;
  var seenA = [];
  var countseenA = 1;
  
  var trialcountB = 0;
  var ProspectB = shuffledProspects[1]/2;
  var AdjustmentB = ProspectB;
  var seenB = [];
  var countseenB = 1;
  
  
  var seeninstructions = false;
  var participant = jsPsych.randomization.randomID(8);
  
  var check_consent = function(elem) {
  if ($('#consent_checkbox').is(':checked')) {
    return true;
  }
  else {
    alert("If you wish to participate, you must check the box next to the statement 'I agree to participate in this study.'");
    return false;
  }
  };
  var consent = {
    type:'html',
    url: "Consent_Phase1.html",
    cont_btn: "start",
    check_fn: check_consent
  };
  
  
  var instruct = {
    type: 'instructions',
    pages: [
      'Thank you for agreeing to assist the Software Usability Research Laboratory (SURL). Click next to read the instructions.',
      'For this task you will be asked to make a series of choices between two hypothetical amounts of money shown on the screen.',
      'Be careful, the differences between the two amounts are subtle. Some amounts will be delayed and/or risky.',
      'Please progress through the experiment as if you were making these decisions in the real world.'
    ],
    show_clickable_nav: true
  };
    
  var instructB = {
    type: 'instructions',
    pages: [
      'You have made it through the first set of hypothetical deals. Click next to read the instructions for the next set',
      'For this task you will be asked to make a series of choices between two hypothetical amounts of money shown on the screen.',
      'Be careful, the amounts have changed compared to the last set. Once again, some amounts will be delayed and/or risky.',
      'Please progress through the experiment as if you were making these decisions in the real world.'
    ],
    show_clickable_nav: true
  };
  
  
  var factors = {
    Odd: Odds,
    Delay: Delays,
  };
  
  
  //used to identify the options string for comparison later
  var temp_arrayA = [];
  /*global jsPsych*/
  var full_designA = jsPsych.randomization.factorial(factors,5);
  var multi_choice_blockA = {
      type: 'survey-multi-choice',
      questions: page_1_questions,
      required: [true],
      options: function() {
       updateProgressBar2();
        if (trialcountA > 0){
          for (var i = 0;i < seen.length; i++){
            if (seen[i][0]==full_designA[trialcountA].Delay +" "+ full_designA[trialcountA].Odd){
              ProspectA=seen[i][1];
              countseen=seen[i][2]+1;
            }
          }
        }
        temp_arrayA = ["$" + ProspectA + " right now", full_designA[trialcountA].Odd+" chance of receiving $"+shuffledProspects[0]+" "+ full_designA[trialcountA].Delay];
        return [temp_arrayA];
      }
  };
  
  //used to identify the options string for comparison later
  var temp_arrayB = [];
  /*global jsPsych*/
  var full_designB = jsPsych.randomization.factorial(factors,5);
  var multi_choice_blockB = {
      type: 'survey-multi-choice',
      questions: page_1_questions,
      required: [true],
      options: function() {
       updateProgressBar2();
        if (trialcountB > 0){
          for (var i = 0;i < seen.length; i++){
            if (seen[i][0]==full_designB[trialcountB].Delay +" "+ full_designB[trialcountB].Odd){
              ProspectB=seen[i][1];
              countseen=seen[i][2]+1;
            }
          }
        }
        temp_arrayB = ["$" + ProspectB + " right now", full_designB[trialcountB].Odd+" chance of receiving $"+shuffledProspects[1]+" "+ full_designB[trialcountB].Delay];
        return [temp_arrayB];
      }
  };
  
  
  //adjust to make experiemnt shorter for testing
  var iterA = full_designA.length; // this is max length
  var loop_nodeA = {
    timeline: [multi_choice_blockA],
    loop_function: function(){
      if(iterA >= 1){
        return true;
      } else {
        return false;
      }
    }
  };
  
  //adjust to make experiemnt shorter for testing
  var iterB = full_designB.length; // this is max length
  var loop_nodeB = {
    timeline: [multi_choice_blockB],
    loop_function: function(){
      if(iterB >= 1){
        return true;
      } else {
        return false;
      }
    }
  };
  
  //used to identify what the participant answered
  function adjuster(ans, sure) {
    if(ans==sure){
      return true;
    } else {
      return false;
    }
  }
  
  function drawProgressBar2() {
    $('body').prepend($('<div id="jspsych-progressbar-container"><span>Completion Progress</span><div id="jspsych-progressbar-outer"><div id="jspsych-progressbar-inner"></div></div></div>'));
  }
  function updateProgressBar2() {
    var progress = ((trialcountA+trialcountB)/(full_designA.length*2))*100;
    $('#jspsych-progressbar-inner').css('width', progress + "%");
  }
  function save_data(filename, filedata){
    $.ajax({
      type:'post',
      cache: false,
      url: 'datawrite.php', // this is the path to the above PHP script
      data: {filename: filename, filedata: filedata}
   });
  }
  
  
  var timeline = [];
  timeline.push(consent);
  timeline.push(instruct);
  timeline.push(loop_nodeA);
  timeline.push(instructB);
  timeline.push(loop_nodeB);
  jsPsych.init({
    /*global  $*/
    display_element: $('#jspsych-target'),
    timeline: timeline,
    progress: drawProgressBar2(),
    on_trial_finish: function() {
      if (jsPsych.currentTimelineNodeID()=='0.0-0.0' || jsPsych.currentTimelineNodeID() =='0.0-1.0'){
        seeninstructions = true;
      } else if (jsPsych.currentTimelineNodeID()[4] == '2') {
      var data = jsPsych.data.getTrialsOfType('survey-multi-choice')[trialcountA+trialcountB].responses;
      var answer = JSON.parse(data);
      iterA = iterA -1;
      //used to adjust the subjective value
        if (adjuster(answer['Q0'],temp_arrayA[0])){
          ProspectA = ProspectA - AdjustmentA*Math.pow(.5,countseenA);
        } else {
          ProspectA = ProspectA + (AdjustmentA*Math.pow(.5,countseenA));
        }
      seen.push([full_designA[trialcountA].Delay +" "+ full_designA[trialcountA].Odd, ProspectA, countseenA]);
      jsPsych.data.addDataToLastTrial({deal:full_designA[trialcountA].Delay +" "+ full_designA[trialcountA].Odd, delay:full_designA[trialcountA].Delay, odd:full_designA[trialcountA].Odd, subvalue:ProspectA, timesseen:countseenA});
      trialcountA++;
      countseenA = 1;
      ProspectA = shuffledProspects[0]/2;
      } else if (jsPsych.currentTimelineNodeID()[4] == '4') {
      var data = jsPsych.data.getTrialsOfType('survey-multi-choice')[trialcountA+trialcountB].responses;
      var answer = JSON.parse(data);
      iterB = iterB -1;
      //used to adjust the subjective value
        if (adjuster(answer['Q0'],temp_arrayB[0])){
          ProspectB = ProspectB - AdjustmentB*Math.pow(.5,countseenB);
        } else {
          ProspectB = ProspectB + (AdjustmentB*Math.pow(.5,countseenB));
        }
      seen.push([full_designB[trialcountB].Delay +" "+ full_designB[trialcountB].Odd, ProspectB, countseenB]);
      jsPsych.data.addDataToLastTrial({deal:full_designB[trialcountB].Delay +" "+ full_designB[trialcountB].Odd, delay:full_designB[trialcountB].Delay, odd:full_designB[trialcountB].Odd, subvalue:ProspectB, timesseen:countseenB});
      trialcountB++;
      countseenB = 1;
      ProspectB = shuffledProspects[1]/2;
      }
    },
    on_finish: function() {
      window.alert("You have completed the experiment. Feel free to close your browser tab");
      save_data(participant+"data.JSON",jsPsych.data.dataAsJSON());
      updateProgressBar2();
    }
  });
  </script>
</html>
